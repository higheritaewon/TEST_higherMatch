<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>HIGHER MATCH</title>
<link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#0c1a3a;
    --yellow:#ffd94d;
    --bg:#0f1730;
    --card:#131e3f;
    --text:#f4f6ff;
    --muted:#97a2c9;
    --danger:#ff6b6b;
    --success:#2dd4bf;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0a142e 55%,#08102a);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;
    font-size:18px; /* 📈 기본 폰트 약 +1~2pt */
    line-height:1.45;
  }
  .container{max-width:480px;margin:0 auto;padding:16px 14px 28px}
  .card{
    background:rgba(19,30,63,.7);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1,h2,h3{margin:0 0 14px}
  h1.title{
    font-size:30px; /* 📈 */
    letter-spacing:.8px; text-align:center; margin-top:8px;
    background:linear-gradient(90deg,#fff,var(--yellow)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    font-family: 'Do Hyeon', sans-serif;
  }
  .page-title{
    text-align:center; font-size:24px; /* 📈 */
    margin-bottom:8px;
    font-family: 'Do Hyeon', sans-serif;
  }
  .subtitle{color:var(--muted); font-size:18px; /* 📈 */ text-align:center; margin-top:-6px; margin-bottom:14px}

  .logo-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:8px 0 16px}
  .logo{
    width:240px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;
  }
  .logo-mini{
    width:200px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;margin:0 auto 6px;
  }

  .row{display:flex;gap:10px}
  input,button,textarea,select{
    width:100%; padding:14px 13px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08); background:#0b1532; color:#f4f6ff; font-size:16px; /* 📈 */
  }
  input::placeholder,textarea::placeholder{color:#7e8bb8}
  textarea{resize:none; min-height:90px}
  button{cursor:pointer; font-weight:700; letter-spacing:.2px}
  .btn{background:#13265a}
  .btn:hover{filter:brightness(1.06)}
  .btn-primary{background:var(--yellow); color:#1a1a1a; border-color:#0000}
  .btn-accent{background:#1a2b63; border:1px solid #2a3b7a}
  .btn-like{background:#1c2f6e; border:1px solid #2e4aa7}
  .btn-focus{outline:2px solid var(--yellow)}
  .btn-danger{background:var(--danger)}
  .btn-success{background:var(--success); color:#0e2824}
  .badge{
    display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.15);
    border-radius:999px; font-size:18px; /* 📈 */
    background:#0e1f4a;
  }

  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .tile{
    display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
    padding:18px 12px; border-radius:14px; text-align:center;
    min-height:200px; /* 📈 세로 2배 */
    background:#0f1f4b; border:1px solid rgba(255,255,255,.06)
  }
  .tile strong{font-size:30px; /* 📈 */ font-family:'Do Hyeon', sans-serif;}
  .tile.like{background:#14265a; border:1px solid #29418d; box-shadow:0 0 0 2px rgba(41,65,141,.25) inset}
  .tile.like strong{ color: var(--yellow); }

  .muted{color:var(--muted); font-size:16px} /* 📈 */
  .small{font-size:14px} /* 📈 */
  .center{text-align:center}
  .spacer{height:8px}
  .footerbar{
    margin-top:16px; display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-size:14px /* 📈 */
  }
  .list{display:flex;flex-direction:column; gap:10px}
  .list-item{
    display:flex; align-items:center; gap:10px;
    padding:12px; border-radius:12px; background:#0d1a3e; border:1px solid rgba(255,255,255,.06)
  }
/* 검색 행: 한 줄 정렬 + 간격 */
.search-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0 10px;
}

/* 🔹 입력창을 넓게: flex=1 로 남는 공간 전부 차지 */
#browse-search-input{
  flex:1 1 auto;           /* 남는 폭 대부분을 가져감 */
  min-width:0;             /* flex 수축 시 내용 넘침 방지 */
  padding:12px 12px;
  font-size:16px;
  border-radius:10px;
}

/* 🔹 버튼은 좁게: 고정(or 최소) 폭 + 줄어들지 않게 */
#browse-search-btn,
#browse-search-clear{
  flex:0 0 88px;           /* 가로 88px 고정 (원하면 72~96px로 조정) */
  padding:10px 0;
  text-align:center;
  font-size:15px;
  border-radius:10px;
}
  
  .hidden{display:none !important}

  .li-content{ flex: 2; min-width:0; }
  .li-actions{ flex: 1; display:flex; justify-content:flex-end; align-items:stretch; }
  .li-actions .btn-like{ width:100%; }

  /* ===== MODAL: 1.5x 확대 + 가독성 ===== */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50
  }
  .modal{
    width:90%; max-width:480px; /* 약간 확대 */
    background:#0d1534; border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:18px;
    font-size:1.5em; line-height:1.4; /* 📈 전체 1.5배 */
  }
  .modal h3{margin:0 0 10px; font-size:1.2em;} /* 제목도 큼직하게 */
  .modal .actions{display:flex; gap:12px; margin-top:14px}
   #modal-title, #modal-message { text-align: center; }
   #modal-message {
     font-size: 18px; line-height: 1.5;}
  /* ===== 로딩 오버레이 ===== */
  .loading-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center; z-index:60;
  }
  .loading-box{
    background:#0d1534; border:1px solid rgba(255,255,255,.12);
    padding:14px 16px; border-radius:12px; font-size:16px;
    display:flex; align-items:center; gap:10px;
  }
  .spinner{
    width:16px; height:16px; border:3px solid rgba(255,255,255,.2); border-top-color:#fff;
    border-radius:50%; animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== BIG LIKE COUNTER ===== */
  .counter-banner{
    margin:6px 0 12px; /* 약간 여백 확대 */
    padding:14px 16px;
    border-radius:14px;
    background:#09163a;
    border:1px solid rgba(255,255,255,.08);
    text-align:center;
  }
  .counter-banner .num{
    font-size:28px; /* 📈 */
    font-weight:800; letter-spacing:.5px;
    font-family:'Do Hyeon', sans-serif;
  }
  .counter-banner .cap{display:block; margin-top:6px; font-size:16px; color:var(--muted)}
  .counter-banner.exhausted{background:#2a0e12; border-color:#3b1318}
</style>
</head>
<body>
<div class="container">

  <!-- ===== [PAGE] 첫페이지 ===== -->
  <section id="page-welcome" class="card">
    <div class="logo-wrap">
      <img id="logo-main" class="logo" src="https://lh3.googleusercontent.com/d/143lu87wt27PIerpMbBNSViSsHabI0dZd" alt="HIGHER MATCH 로고" />
    </div>
    <h1 class="title">HIGHER에서 인연 찾기</h1>
    <div class="spacer"></div>
    <div class="row">
      <input id="login-uid" inputmode="numeric" pattern="[0-9]*" placeholder="나의 고유번호" />
      <input id="login-pin" inputmode="numeric" pattern="[0-9]*" placeholder="비밀번호(4자리)" maxlength="4" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="signup-btn">등록하기</button>
      <button class="btn-primary" id="login-btn">로그인</button>
    </div>
    <div class="spacer"></div>
    <div class="center">
      <button id="admin-entry-btn" class="btn-accent small">관리자</button>
    </div>
    <div class="spacer"></div>
    <p class="subtitle small">
      <br>이벤트용 익명 서비스입니다.<br>BETA SERVICE @higher_itaewon<br>
    </p>
  </section>

  <div id="topbar-common" class="hidden"></div>

  <!-- ===== [PAGE] 메뉴 ===== -->
  <section id="page-menu" class="card hidden">
    <div class="grid">
      <button class="tile" id="btn-profile">
        <strong>프로필<br>설정하기</strong>
        <span class="muted small">자기소개·이상형</span>
      </button>
      <button class="tile" id="btn-browse">
        <strong>다른사람<br>구경하기</strong>
        <span class="muted small">번호순 프로필</span>
      </button>
      <button class="tile like" id="btn-like">
        <strong>👍<br>LIKE<br>보내기</strong>
        <span class="muted small">번호 입력하여 전송</span>
      </button>
      <button class="tile" id="btn-matches">
        <strong>나의<br>MATCH<br>💛</strong>
        <span class="muted small">만남 요청/수락</span>
      </button>
    </div>

    <p id="login-status-menu" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <span></span>
      <button id="logout-btn" class="btn small">로그아웃</button>
    </div>
  </section>

  <!-- ===== [PAGE] 프로필 설정하기 ===== -->
  <section id="page-profile" class="card hidden">
    <img class="logo-mini" id="logo-mini-profile" alt="로고" />
    <h2 class="page-title">프로필 설정하기</h2>

    <p class="muted">내 고유번호: <span class="badge" id="me-uid-profile"></span><br>*민감하거나 불쾌감을 줄 수 있는 내용 작성은 자제바랍니다.</p>
    <textarea id="intro" maxlength="50" placeholder="자기소개 (최대 50자)  ex. 오늘 번개 구해요."></textarea>
    <div class="spacer"></div>
    <textarea id="ideal" maxlength="50" placeholder="이상형 (최대 50자)  ex. 짧은 머리 감자상"></textarea>

    <p id="login-status-profile-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="profile-cancel">취소</button>
      <button class="btn-primary" id="profile-save">저장</button>
    </div>
    <div class="footerbar">
      <button id="to-menu1" class="btn small">뒤로가기 ↩️</button>
      <button id="logout-btn1" class="btn small">로그아웃</button>
    </div>
  </section>

  <!-- ===== [PAGE] 다른사람 구경하기 ===== -->
  <section id="page-browse" class="card hidden">
    <img class="logo-mini" id="logo-mini-browse" alt="로고" />
    <h2 class="page-title">다른사람 구경하기</h2>

    <!-- BIG counter -->
    <div id="like-counter-browse" class="counter-banner">
      <span class="num" id="like-remaining-browse-num">남은 LIKE: 0 / 0</span>
      <span class="cap">LIKE는 이벤트당 제한됩니다</span>
    </div>

    <!-- 검색바 -->
    <div class="search-row">
      <input id="browse-search-input" inputmode="numeric" pattern="[0-9]*" placeholder="번호로 검색 (예: 12)" />
      <button id="browse-search-btn" class="btn small">검색</button>
      <button id="browse-search-clear" class="btn small">전체</button>
    </div>

    <div id="browse-list" class="list"></div>

    <p id="login-status-browse-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu2" class="btn small">뒤로가기 ↩️</button>
      <button id="logout-btn2" class="btn small">로그아웃</button>
    </div>
  </section>

  <!-- ===== [PAGE] LIKE 보내기 ===== -->
  <section id="page-like" class="card hidden">
    <img class="logo-mini" id="logo-mini-like" alt="로고" />
    <h2 class="page-title">👍LIKE 보내기</h2>

    <!-- BIG counter -->
    <div id="like-counter-like" class="counter-banner">
      <span class="num" id="like-remaining-like-num">남은 LIKE: 0 / 0</span>
      <span class="cap">남은 횟수가 0이면 LIKE를 보낼 수 없습니다</span>
    </div>

    <div class="row">
      <input id="from-like" disabled />
      <input id="to-like" inputmode="numeric" pattern="[0-9]*" placeholder="상대 고유번호 입력" />
    </div>
    <div class="spacer"></div>
    <button id="send-like-btn" class="btn-like btn-focus">LIKE 보내기</button>
    <p class="muted small" style="margin-top:10px;">※ 존재하지 않는 번호로는 전송되지 않습니다.</p>

    <p id="login-status-like-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu3" class="btn small">뒤로가기 ↩️</button>
      <button id="logout-btn3" class="btn small">로그아웃</button>
    </div>
  </section>

  <!-- ===== [PAGE] 나의 MATCH 현황보기 ===== -->
  <section id="page-matches" class="card hidden">
    <img class="logo-mini" id="logo-mini-matches" alt="로고" />
    <h2 class="page-title">나의 MATCH 💛</h2>

    <div id="matches-list" class="list"></div>

    <p id="login-status-matches-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu4" class="btn small">뒤로가기 ↩️</button>
      <button id="logout-btn4" class="btn small">로그아웃</button>
    </div>
  </section>

  <!-- ===== [PAGE] 관리자 게이트 ===== -->
  <section id="page-admin-gate" class="card hidden">
    <h2>관리자 로그인</h2>
    <p class="muted small">관리자 자격은 코드 내부에 고정되어 있습니다.</p>
    <div class="row">
      <input id="admin-id" placeholder="관리자 아이디" />
      <input id="admin-pw" placeholder="관리자 비밀번호" type="password" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button id="admin-cancel" class="btn">취소</button>
      <button id="admin-login" class="btn-primary">관리자 접속</button>
    </div>
  </section>

  <!-- ===== [PAGE] 관리자 ===== -->
  <section id="page-admin" class="card hidden">
    <h2>관리자 페이지</h2>
    <div class="spacer"></div>

    <div class="row">
      <input id="event-id-input" placeholder="이벤트 ID" />
      <button id="apply-event-id" class="btn">이벤트ID 적용</button>
    </div>
    <p class="small muted">현재 이벤트: <span class="badge" id="current-event"></span></p>

    <div class="row" style="margin-top:10px;">
      <button id="admin-tab-search" class="btn">사용자<br>검색/관리</button>
      <button id="admin-tab-matches" class="btn">매치/만남 목록</button>
      <button id="admin-tab-draw" class="btn">랜덤<br>번호뽑기</button>
    </div>

    <!-- 사용자 검색/관리 -->
    <div id="admin-panel-search" style="margin-top:12px;">
      <h3>사용자 검색/관리</h3>
      <div class="row">
        <input id="admin-search-uid" inputmode="numeric" pattern="[0-9]*" placeholder="고유번호 입력" />
        <button id="admin-search-btn" class="btn">조회</button>
      </div>
      <div id="admin-user-summary" class="small muted" style="margin:8px 0;"></div>

      <div class="row">
        <input id="admin-like-limit" inputmode="numeric" pattern="[0-9]*" placeholder="제한" />
        <button id="admin-like-limit-dec" class="btn">-</button>
        <button id="admin-like-limit-inc" class="btn">+</button>
        <button id="admin-like-limit-save" class="btn-primary">저장</button>
      </div>

      <h4 style="margin-top:12px">보낸 LIKE 목록</h4>
      <div id="admin-sent-list" class="list"></div>
      <h4 style="margin-top:12px">받은 LIKE 목록</h4>
      <div id="admin-recv-list" class="list"></div>

      <h4 style="margin-top:12px">특정 사용자 데이터 삭제)</h4>
      <div class="row">
        <button id="admin-wipe-user" class="btn-danger">이 사용자 데이터 전부 삭제</button>
      </div>
    </div>

    <!-- 매치/만남 목록 -->
    <div id="admin-panel-matches" class="hidden" style="margin-top:12px;">
      <h3>매치/만남 목록</h3>
      <h4 style="margin-top:8px">MATCH 목록</h4>
      <div id="admin-matches" class="list"></div>
      <p class="small">전체 매치 수: <span class="count" id="admin-match-count">0</span></p>

      <h4 style="margin-top:8px">만남 성사 목록</h4>
      <div id="admin-meetings" class="list"></div>
      <p class="small">전체 성사 수: <span class="count" id="admin-meet-count">0</span></p>

      <h4 style="margin-top:14px">개별 사용자 삭제</h4>
      <div class="row">
        <input id="admin-del-uid" placeholder="삭제할 번호" inputmode="numeric" pattern="[0-9]*" />
        <button id="admin-del-user" class="btn-danger">해당 사용자<br>데이터 삭제</button>
      </div>

      <h4 style="margin-top:14px">이벤트 전체 초기화</h4>
      <button id="admin-reset" class="btn-danger">모든 계정/데이터 완전 삭제</button>
    </div>

    <!-- 랜덤 번호 뽑기 -->
    <div id="admin-panel-draw" class="hidden" style="margin-top:12px;">
      <h3>랜덤 번호 뽑기</h3>
      <p class="small muted">현재 등록된 번호들 중에서 중복 없이 각각의 풀에서 추첨됩니다.</p>
      <div class="row" style="margin-top:8px;">
        <button id="draw-host" class="btn-primary">🎤 진행자용<br>랜덤번호 뽑기</button>
        <button id="draw-guest" class="btn-primary">🎉 참가자용<br>랜덤번호 뽑기</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="draw-reset" class="btn">추첨 초기화</button>
      </div>
      <div style="margin-top:10px;">
        <div><strong>진행자용 이미 뽑힌 번호:</strong> <span id="draw-host-drawn" class="badge"></span></div>
        <div style="margin-top:6px;"><strong>참가자용 이미 뽑힌 번호:</strong> <span id="draw-guest-drawn" class="badge"></span></div>
      </div>
    </div>

    <div class="spacer"></div>
    <button id="admin-logout" class="btn small">관리자 로그아웃</button>
  </section>

</div>

<!-- ===== 기본 모달 ===== -->
<div id="modal" class="modal-backdrop">
  <div class="modal">
    <h3 id="modal-title">알림</h3>
    <div id="modal-message" class="muted" style="white-space:pre-line"></div>
    <div class="actions" id="modal-actions">
      <button id="modal-ok" class="btn-primary">확인</button>
    </div>
  </div>
</div>

<!-- ===== 로딩(대기 안내) 오버레이 ===== -->
<div id="loading" class="loading-backdrop">
  <div class="loading-box">
    <div class="spinner"></div>
    <div>처리 중입니다...</div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, set, update, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ===================== 환경 설정 =====================
  const firebaseConfig = {
    apiKey: "AIzaSyCZK8qb__6LPBr-HAdrUsKbUXpeU1jGuJE",
    authDomain: "test-highermatch.firebaseapp.com",
    databaseURL: "https://test-highermatch-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "test-highermatch",
    storageBucket: "test-highermatch.firebasestorage.app",
    messagingSenderId: "404607090991",
    appId: "1:404607090991:web:7909bd4441354e7285e1da",
    measurementId: "G-PFPGBCLJC9"
  };

  let EVENT_ID = localStorage.getItem("hm_event_id") || "defaultEvent";
  const ADMIN_ID = "admin";
  const ADMIN_PASSWORD = "higher1011!";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ===================== 상태 =====================
  let currentUid = null;
  let currentPin = null;
  let adminLoggedIn = false;
  let isConnected = null;
  let likeRemain = 0;
  let likeLimit = 0;

  // ===================== DOM 헬퍼 =====================
  const $ = s => document.querySelector(s);
  function show(el){
    el.classList.remove("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "flex";
    }
  }
  function hide(el){
    el.classList.add("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "none";
    }
  }

  const loadingEl = $("#loading");
  const withLoading = async (fn) => { try{ show(loadingEl); await fn(); } finally{ hide(loadingEl); } };

  const pages = {
    welcome: $("#page-welcome"),
    menu: $("#page-menu"),
    profile: $("#page-profile"),
    browse: $("#page-browse"),
    like: $("#page-like"),
    matches: $("#page-matches"),
    adminGate: $("#page-admin-gate"),
    admin: $("#page-admin")
  };

  const logoMain = $("#logo-main");
  function setAllMiniLogos(){
    document.querySelectorAll(".logo-mini").forEach(img=>{ img.src = logoMain.src; });
  }
  setAllMiniLogos();

  // ===================== 모달 =====================
  const modal = $("#modal");
  const modalTitle = $("#modal-title");
  const modalMsg = $("#modal-message");
  const modalActions = $("#modal-actions");

  function alertModal(message, title="알림"){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = title;
      modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n"); // 줄바꿈 과도 시 정리
      modalActions.innerHTML = `<button id="modal-ok" class="btn-primary">확인</button>`;
      $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }
  function confirmModal(message, {okText="확인", cancelText="취소", title="확인"}={}){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = title;
      modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n");
      modalActions.innerHTML = `
        <button id="modal-cancel" class="btn">${cancelText}</button>
        <button id="modal-ok" class="btn-primary">${okText}</button>`;
      $("#modal-cancel").onclick = ()=>{ hide(modal); res(false); };
      $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }
  function choiceModal(message){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = "만남 요청";
      modalMsg.textContent = String(message).replace(/\n{3,}/g, "\n\n");
      modalActions.innerHTML = `
        <button id="modal-decline" class="btn-danger">거절</button>
        <button id="modal-hold" class="btn">보류</button>
        <button id="modal-accept" class="btn-primary">수락</button>
      `;
      $("#modal-decline").onclick = ()=>{ hide(modal); res(false); };
      $("#modal-hold").onclick = ()=>{ hide(modal); res(null); };
      $("#modal-accept").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }

  // ===================== 연결 상태 라벨 처리 =====================
  function updateConnectionLabels(){
    const suffix = (isConnected===null) ? "" : (isConnected ? " · 실시간: 연결됨" : " · 실시간: 오프라인");
    const base = currentUid ? `${currentUid}번 님이 로그인 중입니다` : "";
    const textTop = base + suffix;

    ["#login-status-menu","#login-status-profile-top","#login-status-browse-top","#login-status-like-top","#login-status-matches-top"]
      .forEach(sel=>{ const el=$(sel); if(el) el.textContent=textTop; });

    const fromLike = $("#from-like");
    if(fromLike){ fromLike.value = currentUid ? `내 번호: ${currentUid}` : ""; }
  }

  // ===================== DB 유틸 =====================
  const r = (p)=> ref(db, `events/${EVENT_ID}/${p}`);
  async function getUser(uid){ const snap = await get(r(`users/${uid}`)); return snap.exists()? snap.val(): null; }
  async function userExists(uid){ return !!(await getUser(uid)); }
  async function countLikesSent(uid){
    const snap = await get(r(`likes/${uid}`));
    if(!snap.exists()) return 0;
    return Object.keys(snap.val()).length;
  }

  // ===== LIKE 카운터/배너/UI =====
  function setLikeUI(remain, limit){
    likeRemain = remain; likeLimit = limit;
    const n1 = $("#like-remaining-like-num");
    const n2 = $("#like-remaining-browse-num");
    if(n1) n1.textContent = `남은 LIKE: ${remain} / ${limit}`;
    if(n2) n2.textContent = `남은 LIKE: ${remain} / ${limit}`;

    const b1 = $("#like-counter-like");
    const b2 = $("#like-counter-browse");
    const exhausted = (remain<=0);
    [b1,b2].forEach(b=>{ if(!b) return; b.classList.toggle("exhausted", exhausted); });

    // ❗이제 비활성화하지 않음: 클릭 시 알림만 뜨게 핸들러에서 제어
    const sendBtn = $("#send-like-btn");
    if(sendBtn){ sendBtn.title = exhausted ? "LIKE를 모두 사용하였습니다." : ""; }

    document.querySelectorAll("[data-like]").forEach(btn=>{
      btn.title = exhausted ? "LIKE를 모두 사용하였습니다." : "";
    });
  }
  async function refreshLikeCounters(){
    if(!currentUid) return;
    const u = await getUser(currentUid);
    const limit = (u && typeof u.likeLimit==="number") ? u.likeLimit : 5;
    const sentCount = (u && typeof u.likeSentCount==="number") ? u.likeSentCount : await countLikesSent(currentUid);
    const remain = Math.max(0, limit - sentCount);
    setLikeUI(remain, limit);
  }

  // ===================== Auth 초기화 =====================
  async function initAuth(){
    try{
      await setPersistence(auth, inMemoryPersistence);
      await signInAnonymously(auth);
    }catch(e){ console.error("Auth init error:", e); }
    return new Promise((resolve)=>{
      if(auth.currentUser) return resolve(auth.currentUser);
      const unsub = onAuthStateChanged(auth, (u)=>{unsub(); resolve(u);});
    });
  }
  await initAuth();

  // ===================== .info/connected =====================
  onValue(ref(db, ".info/connected"), (snap)=>{
    isConnected = (snap.val() === true);
    updateConnectionLabels();
  });

  // ===================== 회원가입/로그인 =====================
  $("#signup-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid || !/^\d+$/.test(uid)) return alertModal("고유번호는 숫자여야 합니다.");
        if(!/^\d{4}$/.test(pin)) return alertModal("비밀번호는 숫자 4자리여야 합니다.");
        if(await userExists(uid)) return alertModal("이미 존재하는 번호입니다.\n\n로그인해 주세요.");
        await set(r(`users/${uid}`), { pin, intro:"", ideal:"", createdAt: Date.now(), likeLimit:5, likeSentCount:0 });
        await alertModal("계정이 생성 되었습니다.\n\n로그인 후 이용해 주세요.");
      }catch(err){
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        if(String(err && err.code).includes("permission_denied")){
          alertModal("데이터베이스 권한 오류입니다.\n\n- Authentication: Anonymous 활성화 확인\n- Database 규칙(.read/.write) 확인", "권한 오류");
        }else if(msg.includes("databaseURL")){
          alertModal("firebaseConfig.databaseURL이 올바른지 확인해 주세요.", "설정 오류");
        }else{
          alertModal("등록하기 중 오류가 발생했습니다.\n\n" + msg, "오류");
        }
      }
    });
  };

  $("#login-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid) return alertModal("고유번호를 입력하세요.");
        const user = await getUser(uid);
        if(!user){ return alertModal("해당 번호가 없습니다.\n\n다시 시도해 주시기 바랍니다."); }
        if(user.pin !== pin){ return alertModal("비밀번호가 일치하지 않습니다.\n\n다시 시도해 주시기 바랍니다."); }
        currentUid = uid; currentPin = pin;

        // 누락 필드 보정
        const patch = {};
        if(typeof user.likeLimit!=="number") patch.likeLimit = 5;
        if(typeof user.likeSentCount!=="number"){ patch.likeSentCount = await countLikesSent(currentUid); }
        if(Object.keys(patch).length) await update(r(`users/${currentUid}`), patch);

        attachRealtimeListeners();
        await refreshLikeCounters();
        await checkUnseenLikes();   // ✅ 로그인 직후 미확인 LIKE 알림
        go("menu");
      }catch(err){
        console.error(err);
        alertModal("로그인 중 오류가 발생했습니다.\n\n" + ((err && err.message) ? err.message : String(err)));
      }
    });
  };

  // 로그아웃
  function doLogout(){
    detachRealtimeListeners();
    currentUid = null; currentPin = null;
    go("welcome");
  }
  ["#logout-btn","#logout-btn1","#logout-btn2","#logout-btn3","#logout-btn4"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = doLogout;
  });

  // 메뉴 이동
  ["#to-menu1","#to-menu2","#to-menu3","#to-menu4"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = ()=> go("menu");
  });
  $("#btn-profile").onclick = ()=>{ $("#me-uid-profile").textContent = currentUid; loadProfile(); go("profile"); };
  $("#btn-browse").onclick = async ()=>{ await loadBrowse(); await refreshLikeCounters(); go("browse"); };
  $("#btn-like").onclick   = async ()=>{ $("#from-like").value=`내 번호: ${currentUid}`; $("#to-like").value=""; await refreshLikeCounters(); go("like"); };
  $("#btn-matches").onclick= ()=>{ loadMatches(); go("matches"); };

  // 프로필 저장/취소
  async function loadProfile(){
    const u = await getUser(currentUid);
    $("#intro").value = (u && u.intro)||"";
    $("#ideal").value = (u && u.ideal)||"";
  }
  $("#profile-save").onclick = async ()=>{
    await withLoading(async ()=>{
      await update(r(`users/${currentUid}`), {
        intro: $("#intro").value.trim().slice(0,50),
        ideal: $("#ideal").value.trim().slice(0,50)
      });
      await alertModal("프로필이 저장되었습니다.");
      go("menu");
    });
  };
  $("#profile-cancel").onclick = ()=>go("menu");

  // ===== 다른사람 구경 (+검색) =====
  async function loadBrowse(filterUid=null){
    const wrap = $("#browse-list");
    wrap.innerHTML = "";
    const snap = await get(r("users"));
    if(!snap.exists()){ wrap.innerHTML = `<div class="muted small">아직 가입된 사용자가 없습니다.</div>`; return; }
    const users = snap.val();
    let ids = Object.keys(users).filter(id=>id!==currentUid);
    if(filterUid){ ids = ids.filter(x=>x===filterUid); }
    ids.sort((a,b)=>Number(a)-Number(b));
    if(ids.length===0){ wrap.innerHTML = `<div class="muted small">해당 번호의 프로필이 없습니다.</div>`; return; }

    ids.forEach(id=>{
      const u = users[id];
      const item = document.createElement("div");
      item.className="list-item";
      item.innerHTML = `
        <div class="li-content">
          <div><strong>${id}번</strong></div>
          <div class="small muted" style="margin-top:4px;">자기소개: ${u.intro||"-"}</div>
          <div class="small muted" style="margin-top:2px;">이상형: ${u.ideal||"-"}</div>
        </div>
        <div class="li-actions">
          <button class="btn-like small" data-like="${id}">👍LIKE</button>
        </div>
      `;
      wrap.appendChild(item);
    });

    // 버튼 핸들러 (소진 시 알림만)
    wrap.querySelectorAll("[data-like]").forEach(btn=>{
      const toId = btn.getAttribute("data-like");
      btn.onclick = ()=> {
        if(likeRemain<=0){ alertModal("LIKE를 모두 사용하였습니다."); return; }
        sendLike(toId);
      };
    });
  }
  // 검색 UI
  $("#browse-search-btn").onclick = async ()=>{
    const v = $("#browse-search-input").value.trim();
    if(!v || !/^\d+$/.test(v)) return loadBrowse(null);
    await loadBrowse(v);
  };
  $("#browse-search-clear").onclick = ()=>{ $("#browse-search-input").value=""; loadBrowse(null); };

  // ===== LIKE 보내기 =====
  $("#send-like-btn").onclick = async ()=>{
    if(likeRemain<=0){ return alertModal("LIKE를 모두 사용하였습니다."); } // 실행 차단
    const toId = $("#to-like").value.trim();
    if(!/^\d+$/.test(toId)) return alertModal("상대방 번호를 숫자로 입력하세요.");
    await withLoading(async ()=>{ await sendLike(toId); });
  };

  async function sendLike(toId){
    if(!currentUid) return;
    if(likeRemain<=0) return alertModal("LIKE를 모두 사용하였습니다."); // 재확인
    if(toId===currentUid) return alertModal("본인에게는 보낼 수 없습니다.");
    const exists = await userExists(toId);
    if(!exists) return alertModal("해당 번호가 없습니다.\n\n다시 시도해 주시기 바랍니다.");

    // 중복 방지
    const already = await get(r(`likes/${currentUid}/${toId}`));
    if(already.exists()){
      return alertModal("이미 이 사용자에게<br>LIKE를 보냈습니다.");
    }

    // 제한 체크 & 증가 (트랜잭션)
    const userRef = r(`users/${currentUid}`);
    const ok = await runTransaction(userRef, (u)=>{
      if(!u) return u;
      if(typeof u.likeLimit!=="number") u.likeLimit = 5;
      if(typeof u.likeSentCount!=="number") u.likeSentCount = 0;
      if(u.likeSentCount >= u.likeLimit){ return u; } // 더 이상 불가
      u.likeSentCount += 1;
      return u;
    });
    const val = ok && ok.snapshot && ok.snapshot.val();
    if(!val) return alertModal("오류가 발생했습니다.<br>다시 시도해 주세요.");
    if(val.likeSentCount > val.likeLimit){
      await update(userRef, { likeSentCount: val.likeLimit });
      return alertModal("LIKE를 모두 사용하였습니다.");
    }

    // 실제 LIKE 저장
    await set(r(`likes/${currentUid}/${toId}`), true);

    // 수신 인덱스(미확인)
    await set(r(`likesReceived/${toId}/${currentUid}`), { ok:true, updatedAt: Date.now(), seen:false });

    // 매치 여부
    const reciprocal = await get(r(`likes/${toId}/${currentUid}`));
    if(reciprocal.exists()){
      const payload = {status:"matched", updatedAt: Date.now()};
      await update(r(`matches/${currentUid}/${toId}`), payload);
      await update(r(`matches/${toId}/${currentUid}`), payload);
      await alertModal(`${toId}번 사용자와 MATCH가 되었습니다!\n\n매치 현황을 확인해 주시기 바랍니다.`);
    }else{
      await alertModal("LIKE가 전송되었습니다.");
    }

    await refreshLikeCounters(); // 소진되면 이후 클릭 시 알림만
  }

  // ===== LIKE 수신 미확인 알림 처리 =====
  async function checkUnseenLikes(){
    if(!currentUid) return;
    const snap = await get(r(`likesReceived/${currentUid}`));
    if(!snap.exists()) return;
    const recvs = snap.val();
    for(const from of Object.keys(recvs)){
      const v = recvs[from];
      if(v && v.ok && v.seen===false){
        await alertModal("누군가에게 LIKE를 받았습니다.", "LIKE 알림");
        await update(r(`likesReceived/${currentUid}/${from}`), { seen:true });
      }
    }
  }

  // ===== 나의 MATCH 현황 (+ 보류 처리) =====
  async function loadMatches(){
    const wrap = $("#matches-list");
    wrap.innerHTML = "";

    // 매치 목록
    const snap = await get(r(`matches/${currentUid}`));
    if(snap.exists()){
      const list = snap.val();
      const ids = Object.keys(list).sort((a,b)=>Number(a)-Number(b));
      ids.forEach(other=>{
        const m = list[other];
        const row = document.createElement("div");
        row.className="list-item";
        let right = "";
        if(m.status==="matched"){
          right = `<button class="btn-success small" data-meet="${other}">만남 요청하기</button>`;
        }else if(m.status==="meeting_requested"){
          right = `<span class="small badge">요청 진행중</span>`;
        }else if(m.status==="meeting_accepted"){
          right = `
            <span class="small badge" style="background:#14532d;border-color:#1d7a49">만남<br>성사</span>
            <button class="btn small" data-staff="${other}">직원<br>확인</button>
          `;
        }
        row.innerHTML = `
          <div class="li-content">
            <div><strong>${other}번</strong></div>
            <div class="small muted">상태: ${statusKorean(m.status)}</div>
          </div>
          <div class="li-actions">${right}</div>
        `;
        wrap.appendChild(row);
      });

      wrap.querySelectorAll("[data-meet]").forEach(btn=>{
        btn.onclick = async ()=>{
          const target = btn.getAttribute("data-meet");
          await withLoading(async ()=>{
            await set(r(`meetingRequests/${target}/${currentUid}`), {status:"pending", updatedAt: Date.now()});
            await update(r(`matches/${currentUid}/${target}`), {status:"meeting_requested", updatedAt: Date.now()});
          });
          await alertModal("만남 요청이 전송되었습니다.");
          loadMatches();
        };
      });

      wrap.querySelectorAll("[data-staff]").forEach(btn=>{
        btn.onclick = async ()=>{
          const other = btn.getAttribute("data-staff");
          const ok = await confirmModal("직원확인이 완료되면 매치현황은 삭제됩니다.\n\n그래도 진행하시겠습니까?",{okText:"확인",cancelText:"취소"});
          if(!ok) return;
          await withLoading(async ()=>{ await clearPairData(currentUid, other); });
          await alertModal("매치 데이터가 삭제되었습니다.");
          loadMatches();
        };
      });
    }

    // 내가 받은 만남요청(보류/대기)
    const reqSnap = await get(r(`meetingRequests/${currentUid}`));
    if(reqSnap.exists()){
      const reqs = reqSnap.val();
      const froms = Object.keys(reqs).sort((a,b)=>Number(a)-Number(b));
      froms.forEach(fromUid=>{
        const req = reqs[fromUid];
        if(req.status==="pending" || req.status==="held"){
          const row = document.createElement("div");
          row.className = "list-item";
          row.innerHTML = `
            <div class="li-content">
              <div><strong>${fromUid}번</strong></div>
              <div class="small muted">상태: ${req.status==="held"?"보류 중":"만남 요청 도착"}</div>
            </div>
            <div class="li-actions">
              <button class="btn-danger small" data-decline="${fromUid}">거절</button>
              <button class="btn-primary small" data-accept="${fromUid}">수락</button>
            </div>
          `;
          wrap.appendChild(row);
        }
      });

      wrap.querySelectorAll("[data-decline]").forEach(btn=>{
        btn.onclick = async ()=>{
          const fromUid = btn.getAttribute("data-decline");
          await withLoading(async ()=>{ await clearPairData(currentUid, fromUid); });
          loadMatches();
        };
      });
      wrap.querySelectorAll("[data-accept]").forEach(btn=>{
        btn.onclick = async ()=>{
          const fromUid = btn.getAttribute("data-accept");
          await withLoading(async ()=>{
            await update(r(`matches/${currentUid}/${fromUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await update(r(`matches/${fromUid}/${currentUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await remove(r(`meetingRequests/${currentUid}/${fromUid}`));
          });
          await alertModal("만남이 성사되었습니다.\n\n지금바로 만남을 위해<br>직원에게 문의하세요!");
          loadMatches();
        };
      });
    }

    if(!snap.exists() && !reqSnap.exists()){
      wrap.innerHTML = `<div class="muted small">아직 매치/요청이 없습니다.</div>`;
    }
  }

  function statusKorean(s){
    return s==="matched" ? "매치됨"
      : s==="meeting_requested" ? "만남 요청 중"
      : s==="meeting_accepted" ? "만남 성사"
      : s;
  }

  async function clearPairData(a,b){
    const ops = [
      remove(r(`matches/${a}/${b}`)),
      remove(r(`matches/${b}/${a}`)),
      remove(r(`likes/${a}/${b}`)),
      remove(r(`likes/${b}/${a}`)),
      remove(r(`likesReceived/${a}/${b}`)),
      remove(r(`likesReceived/${b}/${a}`)),
      remove(r(`meetingRequests/${a}/${b}`)),
      remove(r(`meetingRequests/${b}/${a}`))
    ];
    await Promise.all(ops);
  }

  // ===================== 실시간 리스너 =====================
  let detachFns = [];
  function attachRealtimeListeners(){
    detachRealtimeListeners();
    if(!currentUid) return;

    // 내 매치 상태 변화
    const off1 = onValue(r(`matches/${currentUid}`), snap=>{
      if(!snap.exists()) return;
      const data = snap.val();
      Object.entries(data).forEach(([other, m])=>{
        if(m && m.status==="matched" && (Date.now()-m.updatedAt)<4000){
          alertModal(`${other}번 사용자와<br>MATCH가 되었습니다!\n\n매치 현황을 확인해 주시기 바랍니다.`);
        }
        if(m && m.status==="meeting_accepted" && (Date.now()-m.updatedAt)<4000){
          alertModal("만남이 성사되었습니다.\n\n지금바로 만남을 위해 직원에게 문의하세요!");
        }
      });
      if(!pages.matches.classList.contains("hidden")) loadMatches();
    });
    detachFns.push(()=>off1());

    // 내가 받은 만남 요청
    const off2 = onValue(r(`meetingRequests/${currentUid}`), async snap=>{
      if(!snap.exists()) return;
      const reqs = snap.val();
      for(const fromUid of Object.keys(reqs)){
        const req = reqs[fromUid];
        if(req.status==="pending"){
          const accepted = await choiceModal(`${fromUid}번과의 만남 요청을 수락하시겠습니까?`);
          if(accepted===true){
            await update(r(`matches/${currentUid}/${fromUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await update(r(`matches/${fromUid}/${currentUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await remove(r(`meetingRequests/${currentUid}/${fromUid}`));
            await alertModal("만남이 성사되었습니다.\n\n지금바로 만남을 위해<br>직원에게 문의하세요!");
          }else if(accepted===false){
            await clearPairData(currentUid, fromUid);
          }else{
            await update(r(`meetingRequests/${currentUid}/${fromUid}`), {status:"held", updatedAt: Date.now()});
          }
        }
      }
      if(!pages.matches.classList.contains("hidden")) loadMatches();
    });
    detachFns.push(()=>off2());

    // 받은 LIKE 실시간 알림(미확인 항목)
    const off3 = onValue(r(`likesReceived/${currentUid}`), async snap=>{
      if(!snap.exists()) return;
      const recvs = snap.val();
      for(const from of Object.keys(recvs)){
        const v = recvs[from];
        if(v && v.ok && v.seen===false){
          await alertModal("누군가에게 LIKE를 받았습니다.","LIKE 알림");
          await update(r(`likesReceived/${currentUid}/${from}`), { seen:true });
        }
      }
    });
    detachFns.push(()=>off3());

    updateConnectionLabels();
  }
  function detachRealtimeListeners(){
    detachFns.forEach(fn=>{ try{fn();}catch{} });
    detachFns = [];
    updateConnectionLabels();
  }

  // ===================== 관리자 =====================
  $("#admin-entry-btn").onclick = ()=> go("adminGate");
  $("#admin-cancel").onclick = ()=> go("welcome");
  $("#admin-login").onclick = ()=>{
    const id = $("#admin-id").value.trim();
    const pw = $("#admin-pw").value.trim();
    if(id===ADMIN_ID && pw===ADMIN_PASSWORD){
      adminLoggedIn = true;
      $("#current-event").textContent = EVENT_ID;
      go("admin");
      setAdminTab("search");
    }else{
      alertModal("관리자 인증 실패");
    }
  };
  $("#admin-logout").onclick = ()=>{ adminLoggedIn = false; go("welcome"); };

  $("#apply-event-id").onclick = ()=>{
    const v = $("#event-id-input").value.trim();
    if(!v) return alertModal("이벤트 ID를 입력하세요.");
    EVENT_ID = v;
    localStorage.setItem("hm_event_id", EVENT_ID);
    $("#current-event").textContent = EVENT_ID;
    alertModal("이벤트 ID가 적용되었습니다.");
    if(adminLoggedIn) setAdminTab(currentAdminTab);
  };

  // --- 관리자 탭 ---
  let currentAdminTab = "search";
  function setAdminTab(tab){
    currentAdminTab = tab;
    $("#admin-panel-search").classList.toggle("hidden", tab!=="search");
    $("#admin-panel-matches").classList.toggle("hidden", tab!=="matches");
    $("#admin-panel-draw").classList.toggle("hidden", tab!=="draw");
    if(tab==="matches"){ renderAdminMatches(); }
    if(tab==="draw"){ renderDrawState(); }
  }
  $("#admin-tab-search").onclick = ()=> setAdminTab("search");
  $("#admin-tab-matches").onclick = ()=> setAdminTab("matches");
  $("#admin-tab-draw").onclick = ()=> setAdminTab("draw");

  // --- 관리자: 사용자 검색/관리 ---
  $("#admin-search-btn").onclick = async ()=>{
    const uid = $("#admin-search-uid").value.trim();
    if(!uid || !/^\d+$/.test(uid)) return alertModal("고유번호를 올바르게 입력하세요.");
    const u = await getUser(uid);
    if(!u) {
      $("#admin-user-summary").textContent = "존재하지 않는 사용자입니다.";
      $("#admin-sent-list").innerHTML=""; $("#admin-recv-list").innerHTML="";
      return;
    }

    $("#admin-user-summary").textContent =
      `${uid}번 사용자 · LIKE 제한: ${(typeof u.likeLimit==="number")?u.likeLimit:5} · 보낸횟수: ${(typeof u.likeSentCount==="number")?u.likeSentCount:await countLikesSent(uid)}`;

    $("#admin-like-limit").value = (typeof u.likeLimit==="number")?u.likeLimit:5;

    // 보낸 LIKE
    const sent = await get(r(`likes/${uid}`));
    const sentBox = $("#admin-sent-list"); sentBox.innerHTML="";
    if(sent.exists()){
      Object.keys(sent.val()).sort((a,b)=>Number(a)-Number(b)).forEach(to=>{
        const item = document.createElement("div");
        item.className="list-item";
        item.innerHTML = `<div class="li-content"><strong>${uid}번 → ${to}번</strong></div>`;
        sentBox.appendChild(item);
      });
    }else{
      sentBox.innerHTML = `<div class="muted small">보낸 LIKE 없음</div>`;
    }

    // 받은 LIKE (likesReceived 인덱스)
    const recv = await get(r(`likesReceived/${uid}`));
    const recvBox = $("#admin-recv-list"); recvBox.innerHTML="";
    if(recv.exists()){
      Object.keys(recv.val()).sort((a,b)=>Number(a)-Number(b)).forEach(from=>{
        const item = document.createElement("div");
        item.className="list-item";
        item.innerHTML = `<div class="li-content"><strong>${from}번 → ${uid}번</strong></div>`;
        recvBox.appendChild(item);
      });
    }else{
      recvBox.innerHTML = `<div class="muted small">받은 LIKE 없음</div>`;
    }

    // 빠른 삭제 버튼에 대상 uid 기억
    $("#admin-wipe-user").dataset.uid = uid;
  };

  $("#admin-like-limit-dec").onclick = ()=>{
    const inp = $("#admin-like-limit"); let v = parseInt(inp.value||"5",10); v = isNaN(v)?5:Math.max(0, v-1); inp.value = v;
  };
  $("#admin-like-limit-inc").onclick = ()=>{
    const inp = $("#admin-like-limit"); let v = parseInt(inp.value||"5",10); v = isNaN(v)?5:v+1; inp.value = v;
  };
  $("#admin-like-limit-save").onclick = async ()=>{
    const uid = $("#admin-search-uid").value.trim();
    const v = parseInt($("#admin-like-limit").value||"5",10);
    if(!uid || !/^\d+$/.test(uid)) return alertModal("먼저 사용자 번호를 조회하세요.");
    if(isNaN(v) || v<0) return alertModal("LIKE 제한은 0 이상의 숫자여야 합니다.");
    await update(r(`users/${uid}`), { likeLimit: v });
    alertModal("LIKE 제한이 저장되었습니다.");
  };

  // 검색 탭에서 “이 사용자 데이터 전부 삭제”
  $("#admin-wipe-user").onclick = async ()=>{
    const uid = $("#admin-wipe-user").dataset.uid || $("#admin-search-uid").value.trim();
    if(!uid) return alertModal("먼저 사용자 번호를 조회하세요.");
    const ok = await confirmModal(`${uid}번 사용자의 모든 데이터를 삭제합니다.\n\n계속할까요?`,{okText:"삭제"});
    if(!ok) return;

    await withLoading(async ()=>{
      const ops = [
        remove(r(`users/${uid}`)),
        remove(r(`likes/${uid}`)),
        remove(r(`likesReceived/${uid}`)),
        remove(r(`matches/${uid}`)),
        remove(r(`meetingRequests/${uid}`))
      ];
      // 양방향 정리
      const likesAll = await get(r(`likes`));
      if(likesAll.exists()){
        const all = likesAll.val();
        for(const from of Object.keys(all)){
          if(all[from] && all[from][uid]){
            ops.push(remove(r(`likes/${from}/${uid}`)));
          }
        }
      }
      const recvAll = await get(r(`likesReceived`));
      if(recvAll.exists()){
        const all = recvAll.val();
        for(const to of Object.keys(all)){
          if(all[to] && all[to][uid]){
            ops.push(remove(r(`likesReceived/${to}/${uid}`)));
          }
        }
      }
      const mAll = await get(r(`matches/${uid}`));
      if(mAll.exists()){
        const others = Object.keys(mAll.val());
        others.forEach(other=>{
          ops.push(remove(r(`matches/${uid}/${other}`)));
          ops.push(remove(r(`matches/${other}/${uid}`)));
        });
      }
      const reqAll = await get(r(`meetingRequests`));
      if(reqAll.exists()){
        const all = reqAll.val();
        for(const target of Object.keys(all)){
          if(all[target] && all[target][uid]){
            ops.push(remove(r(`meetingRequests/${target}/${uid}`)));
          }
        }
      }
      await Promise.all(ops);
    });

    await alertModal("해당 사용자의 데이터가 삭제되었습니다.");
    // 화면 갱신
    $("#admin-sent-list").innerHTML=""; $("#admin-recv-list").innerHTML="";
    $("#admin-user-summary").textContent = "삭제 완료";
  };

  // --- 관리자: 매치/만남 목록 분리 ---
  async function renderAdminMatches(){
    const boxMatch = $("#admin-matches"); boxMatch.innerHTML = "";
    const boxMeet  = $("#admin-meetings"); boxMeet.innerHTML = "";
    let pairsMatch = new Set();
    let pairsMeet  = new Set();
    let countMatch = 0;
    let countMeet  = 0;

    const all = await get(r("matches"));
    if(!all.exists()){
      boxMatch.innerHTML = `<div class="muted small">현재 매치 데이터가 없습니다.</div>`;
      boxMeet.innerHTML = `<div class="muted small">현재 만남 성사 데이터가 없습니다.</div>`;
      $("#admin-match-count").textContent = "0";
      $("#admin-meet-count").textContent  = "0";
      return;
    }
    const data = all.val();

    for(const a of Object.keys(data)){
      const others = data[a];
      for(const b of Object.keys(others)){
        const st = (others[b] && others[b].status) || "";
        const key = [Math.min(+a,+b), Math.max(+a,+b)].join("-");
        if(st==="matched"){
          if(pairsMatch.has(key) || pairsMeet.has(key)) continue;
          pairsMatch.add(key);
          countMatch++;
          const item = document.createElement("div");
          item.className="list-item";
          item.innerHTML = `<div class="li-content"><strong>${a}번 ↔ ${b}번</strong> <span class="small badge">매치됨</span></div>`;
          boxMatch.appendChild(item);
        }else if(st==="meeting_accepted"){
          if(pairsMeet.has(key)) continue;
          pairsMeet.add(key);
          countMeet++;
          const item = document.createElement("div");
          item.className="list-item";
          item.innerHTML = `<div class="li-content"><strong>${a}번 ↔ ${b}번</strong> <span class="small badge" style="background:#14532d;border-color:#1d7a49">만남 성사</span></div>`;
          boxMeet.appendChild(item);
        }
      }
    }
    if(countMatch===0) boxMatch.innerHTML = `<div class="muted small">현재 매치된 커플이 없습니다.</div>`;
    if(countMeet===0) boxMeet.innerHTML  = `<div class="muted small">현재 만남남 성사된 커플이 없습니다.</div>`;
    $("#admin-match-count").textContent = String(countMatch);
    $("#admin-meet-count").textContent  = String(countMeet);
  }

  // --- 관리자: 랜덤 번호 뽑기 ---
  async function getAllRegisteredIds(){
    const snap = await get(r("users"));
    if(!snap.exists()) return [];
    return Object.keys(snap.val()).sort((a,b)=>Number(a)-Number(b));
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  async function drawOnce(poolKey){
    const allIds = await getAllRegisteredIds();
    if(allIds.length===0) return alertModal("등록된 번호가 없습니다.");
    const drawnSnap = await get(r(`adminDraw/${poolKey}`));
    const drawnSet = drawnSnap.exists()? new Set(drawnSnap.val()) : new Set();
    const remain = allIds.filter(id=>!drawnSet.has(id));
    if(remain.length===0) return alertModal("더 이상 추첨할 번호가 없습니다.\n\n초기화 후 다시 시도하세요.");
    const pick = shuffle(remain)[0];
    drawnSet.add(pick);
    await set(r(`adminDraw/${poolKey}`), Array.from(drawnSet));
    await alertModal(`${poolKey==="host"?"진행자용":"참가자용"} 추첨 번호: ${pick}번`);
    renderDrawState();
  }
  async function renderDrawState(){
    const host = await get(r(`adminDraw/host`));
    const guest = await get(r(`adminDraw/guest`));
    $("#draw-host-drawn").textContent = host.exists()? host.val().join(", ") : "(없음)";
    $("#draw-guest-drawn").textContent = guest.exists()? guest.val().join(", ") : "(없음)";
  }
  $("#draw-host").onclick  = ()=> drawOnce("host");
  $("#draw-guest").onclick = ()=> drawOnce("guest");
  $("#draw-reset").onclick = async ()=>{
    await remove(r(`adminDraw`));
    await alertModal("전체 추첨 기록이 초기화되었습니다.");
    renderDrawState();
  };

  // --- 관리자: 패널 하단 공용 삭제 버튼들 ---
  $("#admin-del-user").onclick = async ()=>{
    const uid = $("#admin-del-uid").value.trim();
    if(!uid) return alertModal("삭제할 고유번호를 입력하세요.");
    const ok = await confirmModal(`${uid}번 사용자의 모든 데이터를 삭제합니다.\n\n계속할까요?`,{okText:"삭제"});
    if(!ok) return;

    await withLoading(async ()=>{
      const ops = [
        remove(r(`users/${uid}`)),
        remove(r(`likes/${uid}`)),
        remove(r(`likesReceived/${uid}`)),
        remove(r(`matches/${uid}`)),
        remove(r(`meetingRequests/${uid}`))
      ];
      // 반대편 정리
      const likesAll = await get(r(`likes`));
      if(likesAll.exists()){
        const all = likesAll.val();
        for(const from of Object.keys(all)){
          if(all[from] && all[from][uid]) ops.push(remove(r(`likes/${from}/${uid}`)));
        }
      }
      const recvAll = await get(r(`likesReceived`));
      if(recvAll.exists()){
        const all = recvAll.val();
        for(const to of Object.keys(all)){
          if(all[to] && all[to][uid]) ops.push(remove(r(`likesReceived/${to}/${uid}`)));
        }
      }
      const mAll = await get(r(`matches/${uid}`));
      if(mAll.exists()){
        const others = Object.keys(mAll.val());
        others.forEach(other=>{
          ops.push(remove(r(`matches/${uid}/${other}`)));
          ops.push(remove(r(`matches/${other}/${uid}`)));
        });
      }
      const reqAll = await get(r(`meetingRequests`));
      if(reqAll.exists()){
        const all = reqAll.val();
        for(const target of Object.keys(all)){
          if(all[target] && all[target][uid]){
            ops.push(remove(r(`meetingRequests/${target}/${uid}`)));
          }
        }
      }
      await Promise.all(ops);
    });

    await alertModal("해당 사용자의 데이터가 삭제되었습니다.");
    renderAdminMatches();
  };

  $("#admin-reset").onclick = async ()=>{
    const ok = await confirmModal("이 이벤트의 모든 계정과 데이터를 완전히 삭제합니다.\n\n되돌릴 수 없습니다.", { okText:"초기화", cancelText:"취소", title:"전체 초기화" });
    if(!ok) return;
    await withLoading(async ()=>{
      await remove(r(`users`));
      await remove(r(`likes`));
      await remove(r(`likesReceived`));
      await remove(r(`matches`));
      await remove(r(`meetingRequests`));
      await remove(r(`adminDraw`));
    });
    await alertModal("전체 데이터 초기화가 완료되었습니다.");
    renderAdminMatches();
  };

  // ===================== 페이지 전환 =====================
  function go(id){
    Object.values(pages).forEach(hide);
    show(pages[id]);
    updateConnectionLabels();
  }

  // ======== 시작 페이지 ========
  go("welcome");
</script>
</body>
</html>






